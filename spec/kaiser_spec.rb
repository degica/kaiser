RSpec.describe Kaiser do
  it 'has a version number' do
    expect(Kaiser::VERSION).not_to be nil
  end

  let(:cmd) { "#{Dir.pwd}/exe/kaiser #{args}" }
  let(:cmd_output) { `#{cmd}` }

  context "without any subcommands" do
    let(:args) { "" }

    it "prints the full usage" do
      unwrapped_output = cmd_output.gsub("\n", " ")

      SUB_COMMANDS.each { |name, klass|
        # We need to remove all newlines before testing because Optimist wordwraps
        # depending on terminal size.
        usage = klass.new.usage
        unwrapped_usage = usage.gsub("\n", " ")

        name_with_line = "#{name} #{name.to_s.gsub(/./, "-")}"
        unwrapped_usage = klass.new.usage.gsub("\n", " ")

        expect(unwrapped_output).to include(name_with_line)
        expect(unwrapped_output).to include unwrapped_usage
      }
    end
  end

  SUB_COMMANDS.each { |name, klass|
    describe name do
      subject { klass }

      context "with -h" do
        let(:args) { "#{name} -h" }

        it "prints the help message for just #{name} and nothing else" do
          # Remove the help arguments generated by Optimist as they won't be un the usage method
          unwrapped_output = cmd_output.lines.delete_if {|l| l =~ /^  -.+/ }.join

          # Remove all newlines because Optimist will wordwrap according to terminal size
          unwrapped_output.gsub!("\n", " ")
          unwrapped_usage = subject.new.usage.gsub("\n", " ")

          # Now we can check is it's the same as usage.
          expect(unwrapped_output).to eq unwrapped_usage
        end
      end
    end
  }
end
